# FastMQ — ядро (версия 0.3)

FastMQ — это легковесная асинхронная система обмена сообщениями, построенная на основе WebSockets. Версия 0.3 представляет собой значительный архитектурный редизайн ядра системы с акцентом на чистоту архитектуры, модульность и тестируемость.

## Архитектурные улучшения

### Принципы чистой архитектуры
- **Инверсия зависимостей**: Компоненты теперь зависят от абстракций (интерфейсов), а не от конкретных реализаций
- **Разделение ответственности**: Каждый модуль отвечает за свою конкретную задачу
- **Внедрение зависимостей**: Все зависимости передаются явно через конструкторы
- **Отсутствие глобального состояния**: Устранены глобальные переменные и синглтоны

### Ключевые изменения
- Выделены четкие интерфейсы для всех основных компонентов (`IFiltersManager`, `IRegistry`, `IClientFabric`)
- Реализовано явное внедрение зависимостей через конструкторы
- Устранены циклические зависимости между модулями
- Конфигурация создается и передается явно в корне приложения

## Основные компоненты

### Сервер (Server)
- Запускает WebSocket-сервер (адрес и порт конфигурируются через `config.ini`)
- Принимает подключения клиентов в ролях `Producer` или `Consumer`
- Обрабатывает сообщения в формате JSON
- Управляет жизненным циклом клиентских подключений

### Интерфейсы и реализации
- **IFiltersManager/Фильтры** - управление фильтрами и подписками потребителей
- **IRegistry/Реестр** - потокобезопасное хранилище подключенных клиентов с уникальными ID
- **IClientFabric/Фабрика** - создание клиентов по ролям (`/producer` или `/consumer`)
- **IMessageHandler/Обработчик** - обработка и маршрутизация сообщений

### Обработчик сообщений (MessageHandler)
- Принимает сообщения от производителей в формате:
```json
{
  "filters": ["filter_name"],
  "message": "Текст сообщения"
}
```
- Перенаправляет сообщения всем потребителям, подписанным на указанные фильтры

### Консоль управления (Console)
- Интерактивный интерфейс для управления системой в реальном времени
- Поддерживает команды:
  - `/add_filter <name>` — добавление нового фильтра
  - `/remove_filter <name>` — удаление фильтра

## Подключение клиентов

- **Producer**: `ws://localhost:25565/producer`
- **Consumer**: `ws://localhost:25565/consumer`

## Логирование

Все события системы (подключения, сообщения, ошибки) записываются в файлы логов в директории `logs/` с использованием модуля `logging`.

## Конфигурация

Настройки сервера и идентификаторов хранятся в `config.ini`:

```ini
[SERVER_INFO]
server_ip = 0.0.0.0
server_port = 25565

[UNIT_INFO]
start_consumer_id = 0
start_producer_id = 100
```

## Запуск

```bash
python -m core.main
```

## Тестирование

Архитектурные изменения подготовили систему к легкому тестированию:
- Компоненты изолированы и зависят от интерфейсов
- Зависимости можно легко подменять моками в тестах
- Планируется расширение тестового покрытия в следующих версиях

## Преимущества новой архитектуры

1. **Тестируемость**: Компоненты легко тестировать изолированно
2. **Гибкость**: Возможность замены реализаций без изменения кода клиентов
3. **Поддерживаемость**: Четкие границы между модулями упрощают понимание кода
4. **Расширяемость**: Новые функции можно добавлять минимально затрагивая существующий код

Версия 0.3 закладывает прочный фундамент для будущего развития системы, включая возможное добавление сохраняемости сообщений, кластеризации и расширенных возможностей маршрутизации.