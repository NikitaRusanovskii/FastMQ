# FastMQ — ядро (версия 0.4)

FastMQ — это высокопроизводительная асинхронная система обмена сообщений, построенная на основе WebSockets с поддержкой персистентного хранения сообщений. Версия 0.4 представляет собой значительное расширение функциональности с добавлением буферизации сообщений и расширенной системой управления подписками.

> **Важное примечание**: Некоторые компоненты системы, включая реализацию очереди сообщений (MessageQueue), обработчиков команд (CommandHandler) и сообщений (MessageHandler), а также логику основного обработчика сервера (Server.handler), в текущей версии являются базовыми и будут существенно переработаны в следующей версии 0.5 для улучшения производительности, надежности и расширяемости.

## Архитектурные улучшения

### Система буферизации сообщений
- **Двойная буферизация**: Поддержка как in-memory (RAMBuffer), так и персистентного (ROMBuffer) хранилищ сообщений
- **Гарантированная доставка**: Сообщения сохраняются в SQLite базе данных при использовании ROMBuffer

### Расширенная система подписок
- **Динамические фильтры**: Добавление и удаление фильтров через консоль управления
- **Групповая подписка**: Потребители могут быть подписаны на несколько фильтров одновременно
- **Управление через WebSocket**: Консьюмеры могут подписываться на фильтры с помощью /subscribe_on

## Основные компоненты

### Сервер (Server)
- **Асинхронная обработка**: Поддержка тысяч одновременных подключений
- **Ролевая модель**: Клиенты подключаются как Producer (/producer) или Consumer (/consumer)
- **Обработка команд**: Поддержка специальных команд (например, /subscribe_on) прямо через WebSocket

### Система очередей (MessageQueue) - Базовая реализация
> **Примечание**: Текущая реализация MessageQueue является базовой и будет существенно доработана в версии 0.5. На данный момент она предоставляет основную функциональность, но требует существенной доработки логики доставки сообщения и проверки доставки.

- **Автоматическая доставка**: Фоновый процесс непрерывно доставляет сообщения из буфера
- **Повторные попытки**: Настраиваемое количество попыток доставки с экспоненциальной задержкой
- **Балансировка нагрузки**: Поддержка параллельной обработки сообщений

### Буферизация сообщений
- **RAMBuffer**: Высокопроизводительное in-memory хранилище для временных сообщений
- **ROMBuffer**: Персистентное хранилище на основе SQLite с гарантированной сохранностью сообщений
- **Единый интерфейс**: Оба типа буфера реализуют общий интерфейс IBuffer

## Новые возможности версии 0.4

### Консоль управления
Интерактивный CLI с поддержкой команд:
```bash
/add_filter <name>      # Добавление нового фильтра
/remove_filter <name>   # Удаление фильтра
```

### Формат сообщений
```json
{
  "filters": ["filter1", "filter2"],
  "message": "Текст сообщения"
}
```

### Персистентность
- Автоматическое создание SQLite базы данных
- Сохранение сообщений при перезапуске системы
- Гарантированный порядок доставки сообщений

## Конфигурация

`config.ini` теперь включает настройки буферизации:

```ini
[SERVER_INFO]
server_ip = 0.0.0.0
server_port = 25565

[UNIT_INFO]
start_consumer_id = 0
start_producer_id = 100

[QUEUE_SETTINGS]
attempts_count = 5
time_sleep = 5
queue_pause = 5
```

## Запуск системы

```bash
python -m core.main
```

## Подключение клиентов

**Producer:**
```javascript
const ws = new WebSocket('ws://localhost:25565/producer')
```

**Consumer:**
```javascript
const ws = new WebSocket('ws://localhost:25565/consumer')
// Подписка на фильтр
ws.send('/subscribe_on filter_name')
```

## Мониторинг и логирование

Все события системы записываются в директорию `logs/` с детализацией:
- Подключения/отключения клиентов
- Операции с буфером сообщений
- Статус доставки сообщений
- Ошибки и предупреждения

## Преимущества версии 0.4

1. **Надежность**: Гарантированная доставка сообщений даже при перезапуске системы
2. **Масштабируемость**: Поддержка большого количества одновременных подключений
3. **Гибкость**: Возможность выбора между производительностью и надежностью хранения
4. **Удобство управления**: Интерактивная консоль для управления фильтрами
5. **Отказоустойчивость**: Повторные попытки доставки при сбоях сети

## Пример использования

1. Запустите сервер
2. Добавьте фильтры через консоль:
   ```
   /add_filter news
   /add_filter updates
   ```
3. Подключите потребителей:
   ```javascript
   // Consumer 1
   const ws = new WebSocket('ws://localhost:25565/consumer')
   ws.send('/subscribe_on news')
   
   // Consumer 2  
   const ws2 = new WebSocket('ws://localhost:25565/consumer')
   ws2.send('/subscribe_on updates')
   ```
4. Отправьте сообщение:
   ```javascript
   // Producer
   const ws = new WebSocket('ws://localhost:25565/producer')
   ws.send(JSON.stringify({
     filters: ["news", "updates"],
     message: "Важное сообщение"
   }))
   ```

Версия 0.4 закладывает основу для будущих улучшений, включая переработку системы очередей, обработчиков команд и сообщений, а также логики основного обработчика сервера в версии 0.5. 
P.S. Этот README, как и прошлые, написан с помощью deepseek